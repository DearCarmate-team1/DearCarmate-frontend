# Dear Carmate Backend - 요구사항 명세서

## 📋 프로젝트 개요

### **서비스 소개**
- **서비스명**: Dear Carmate
- **목적**: 중고차 계약 관리 서비스
- **난이도**: 중급
- **아키텍처**: Multi-tenant SaaS

### **핵심 비즈니스 모델**
- **플랫폼 관리자**: 전체 시스템 관리, 회사 등록/삭제, 사용자 관리
- **중고차 회사**: 독립적인 데이터 공간에서 차량/고객/계약 관리
- **회사별 직원**: 소속 회사 데이터만 접근 가능

---

## 🎯 핵심 기능 요구사항

### **1. 인증 및 권한 관리**

#### **사용자 유형**
- **플랫폼 관리자 (Admin)**
  - 이메일: `admin@dearcarmate.com`
  - 전체 시스템 관리 권한
  - 회사 등록/삭제/수정
  - 모든 회사 사용자 조회/삭제

- **회사 관리자 (Company Admin)**
  - 이메일: `admin@[회사코드].com`
  - 일반 직원과 동일한 권한 (별도 관리 권한 없음)

- **일반 직원 (Employee)**
  - 이메일: `user[번호]@[회사코드].com`
  - 소속 회사 데이터만 접근

#### **인증 시스템**
- **로그인**: 이메일 + 비밀번호
- **토큰 관리**: JWT Access Token (1시간) + Refresh Token (7일)
- **저장 방식**: HTTP-only 쿠키 (Secure, SameSite=strict)
- **자동 갱신**: 401 응답 시 자동 토큰 갱신
- **로그아웃**: 프론트엔드에서 쿠키 삭제

#### **회원가입 프로세스**
1. 사용자가 회사명과 회사 인증코드 입력
2. 시스템에서 회사 코드 유효성 검증
3. 검증 성공 시 해당 회사에 사용자 등록
4. 자동 로그인 처리

---

### **2. Multi-Tenant 데이터 관리**

#### **회사 관리**
- **회사 등록**: 회사명 + 고유 회사코드
- **회사 수정**: 회사명 변경 가능
- **회사 삭제**: 관련 모든 데이터 cascade 삭제
- **회사 목록**: 페이지네이션, 검색 (회사명, 회사코드)

#### **데이터 격리 정책**
- 모든 주요 엔티티에 `companyId` 필드 필수
- API 요청 시 JWT에서 추출한 `companyId`로 자동 필터링
- 회사 간 데이터 접근 완전 차단
- 관리자만 전체 데이터 접근 가능

---

### **3. 사용자 관리**

#### **사용자 등록**
- **필수 정보**: 이름, 이메일, 사원번호, 연락처, 비밀번호
- **회사 연결**: 회사명 + 회사 인증코드로 검증
- **유효성 검사**: 이메일 중복 확인, 사원번호 회사 내 중복 확인

#### **사용자 정보 수정**
- **2차 인증**: 현재 비밀번호 입력 필수
- **수정 가능 항목**: 사원번호, 연락처, 비밀번호, 프로필 이미지
- **수정 불가 항목**: 이름, 이메일 (비즈니스 정책)

#### **사용자 삭제**
- **자기 계정 삭제**: 본인 계정 탈퇴 가능
- **관리자 권한 삭제**: 플랫폼 관리자가 다른 사용자 삭제 가능

---

### **4. 차량 관리**

#### **차량 등록**
- **필수 정보**: 차량번호, 제조사, 차종, 제조년도, 주행거리, 가격, 사고횟수
- **선택 정보**: 차량 설명, 사고 상세 내용
- **상태 관리**: 보유 중 → 계약 진행 중 → 계약 완료
- **유효성 검사**: 차량번호 회사 내 중복 방지

#### **차량 목록 조회**
- **페이지네이션**: 기본 8개씩
- **검색 기능**: 차량번호, 차종으로 검색
- **필터링**: 차량 상태별 필터 (전체, 보유중, 계약진행중, 계약완료)
- **정렬**: 최신 등록순

#### **차량 대용량 업로드**
- **CSV 파일 지원**: 표준 형식의 차량 데이터
- **트랜잭션 처리**: 일부 실패 시 전체 롤백
- **결과 리포트**: 성공/실패 건수 반환

#### **차량 모델 마스터**
- **제조사별 모델 목록**: 현대(아반떼, 소나타, 그랜저), 기아(K3, K5, K7) 등
- **드롭다운 지원**: 프론트엔드 선택 UI용

---

### **5. 고객 관리**

#### **고객 등록**
- **필수 정보**: 고객명, 성별, 연락처
- **선택 정보**: 연령대, 지역, 이메일, 메모
- **연령대 옵션**: 10대, 20대, 30대, 40대, 50대, 60대, 70대, 80대
- **지역 옵션**: 서울, 경기, 인천, 강원, 충북, 충남, 대전, 경북, 경남, 대구, 울산, 부산, 전북, 전남, 광주, 제주

#### **고객 목록 조회**
- **페이지네이션**: 기본 8개씩
- **검색 기능**: 고객명, 이메일로 검색
- **표시 정보**: 고객명, 계약횟수, 성별, 연락처, 연령대, 지역, 이메일

#### **고객 대용량 업로드**
- **CSV 파일 지원**: 표준 형식의 고객 데이터
- **데이터 검증**: 필수 필드 및 열거형 값 검증
- **트랜잭션 처리**: 데이터 무결성 보장

---

### **6. 계약 관리**

#### **계약 워크플로우**
```
차량 확인 → 가격 협의 → 계약 초안 → 계약 성공
                    ↘               ↗
                      계약 실패
```

- **상태 정의**:
  - `carInspection`: 차량 확인
  - `priceNegotiation`: 가격 협의  
  - `contractDraft`: 계약 초안
  - `contractSuccessful`: 계약 성공
  - `contractFailed`: 계약 실패

#### **계약 등록**
- **필수 정보**: 차량 선택, 고객 선택, 담당자 지정
- **미팅 스케줄**: 최대 3개 미팅 일정 설정
- **알림 설정**: 각 미팅별 알림 시간 설정 (전날, 당일)

#### **계약 보드 (칸반)**
- **상태별 그룹화**: 각 상태별로 계약 건들을 그룹화하여 표시
- **드래그 앤 드롭**: 계약 상태 변경을 위한 드래그 이동
- **실시간 업데이트**: 상태 변경 시 즉시 반영
- **검색 기능**: 고객명, 담당자명으로 검색

#### **계약 상세 정보**
- **기본 정보**: 차량, 고객, 담당자 정보
- **미팅 일정**: 예정된 미팅 목록 및 알림 설정
- **계약 금액**: 최종 계약 가격 (계약 완료 시)
- **완료 일자**: 계약 성사/실패 날짜

---

### **7. 계약서 문서 관리**

#### **계약서 업로드**
- **파일 지원**: PDF, DOC, DOCX 등 문서 형식
- **파일 제한**: 개별 파일 5MB, 총 10개까지
- **계약 연결**: 특정 계약 건에 문서 첨부
- **자동 이메일**: 업로드 시 고객에게 자동 발송

#### **계약서 다운로드**
- **개별 다운로드**: 단일 파일 다운로드
- **일괄 다운로드**: 선택된 여러 파일 ZIP 압축
- **권한 확인**: 같은 회사 사용자만 다운로드 가능

#### **계약서 목록**
- **페이지네이션**: 문서 목록 페이징
- **검색 기능**: 계약서명, 담당자명, 차량번호로 검색
- **표시 정보**: 계약서명, 계약체결일, 문서수, 담당자, 차량번호

#### **초안 관리**
- **초안 저장**: 계약과 연결되지 않은 템플릿 문서
- **초안 목록**: 재사용 가능한 계약서 템플릿 조회

---

### **8. 대시보드 및 통계**

#### **핵심 지표**
- **이달의 매출**: 완료된 계약의 총 금액
- **전월 대비 성장률**: 매출 증감율 계산
- **진행 중인 계약 수**: 미완료 상태의 계약 건수
- **성사된 계약 수**: 완료된 계약 총 건수

#### **차트 데이터**
- **차량 타입별 계약수**: 소형차, 중형차, 대형차 등 계약 현황
- **차량 타입별 매출액**: 차량 카테고리별 매출 분석

#### **데이터 집계**
- **실시간 계산**: 요청 시점 기준 최신 데이터
- **회사별 격리**: 각 회사의 독립적인 통계
- **캐싱 전략**: 자주 조회되는 데이터 임시 저장

---

### **9. 파일 업로드 시스템**

#### **이미지 업로드**
- **지원 형식**: JPG, JPEG, PNG, GIF
- **크기 제한**: 최대 5MB
- **최적화**: 자동 리사이징 및 압축
- **용도**: 사용자 프로필 이미지

#### **문서 업로드**
- **지원 형식**: PDF, DOC, DOCX, XLS, XLSX
- **크기 제한**: 개별 파일 5MB
- **용도**: 계약서 및 관련 문서

#### **CSV 업로드**
- **대용량 처리**: 수천 건의 데이터 일괄 처리
- **검증 로직**: 필수 필드 및 형식 검증
- **오류 처리**: 라인별 오류 내용 상세 제공

---

### **10. 알림 시스템**

#### **이메일 알림**
- **계약서 업로드**: 고객에게 계약서 첨부 이메일 자동 발송
- **미팅 리마인더**: 설정된 시간에 미팅 알림 발송
- **템플릿 관리**: 상황별 이메일 템플릿 관리

#### **알림 설정**
- **알림 시간**: 전날 오전 9시, 당일 오전 9시 (기본값)
- **수신자 설정**: 고객, 담당자 등 수신자 선택
- **템플릿 변수**: 동적 내용 삽입 (고객명, 미팅시간 등)

---

## 🔒 보안 요구사항

### **인증 보안**
- **비밀번호**: bcrypt 해싱 (라운드 12)
- **토큰 보안**: HTTP-only 쿠키, Secure, SameSite 설정
- **토큰 만료**: Access 1시간, Refresh 7일

### **데이터 보안**
- **Multi-tenant 격리**: 회사 간 데이터 완전 분리
- **입력 검증**: 모든 사용자 입력 유효성 검사
- **SQL 인젝션 방지**: Prisma ORM 사용

### **API 보안**
- **CORS 정책**: 허용된 도메인만 접근
- **Rate Limiting**: 분당 요청 수 제한
- **보안 헤더**: Helmet 미들웨어 적용

---

## 📊 성능 요구사항

### **응답 시간**
- **일반 API**: 평균 200ms 이하
- **대용량 업로드**: 10초 이하 (1000건 기준)
- **대시보드 로딩**: 500ms 이하

### **동시 접속**
- **사용자 수**: 100명 동시 접속 지원
- **API 처리량**: 초당 1000 요청 처리

### **데이터베이스**
- **인덱스 최적화**: 자주 조회되는 컬럼 인덱싱
- **쿼리 최적화**: N+1 문제 해결
- **트랜잭션**: 대용량 작업 시 데이터 무결성 보장

---

## 🧪 테스트 요구사항

### **단위 테스트**
- **Service 계층**: 비즈니스 로직 테스트
- **커버리지**: 최소 80% 코드 커버리지
- **Mocking**: 데이터베이스 및 외부 서비스 모킹

### **통합 테스트**
- **API 엔드포인트**: 전체 API 동작 테스트
- **데이터베이스**: 실제 DB와의 통합 테스트
- **인증 플로우**: 로그인부터 API 호출까지 전체 플로우

### **시드 데이터**
- **기본 회사**: 8개 중고차 회사 생성
- **테스트 사용자**: 각 회사별 5-8명 직원 생성
- **샘플 데이터**: 차량, 고객, 계약 샘플 데이터

---

## 📈 모니터링 요구사항

### **로깅**
- **요청 로깅**: 모든 API 요청/응답 기록
- **에러 로깅**: 상세한 에러 정보 및 스택 트레이스
- **비즈니스 로깅**: 중요한 비즈니스 액션 기록

### **메트릭**
- **API 성능**: 응답 시간, 처리량 측정
- **에러율**: 4xx, 5xx 에러 비율 추적
- **사용자 활동**: 로그인, 주요 기능 사용 빈도

---

## 🚀 배포 요구사항

### **환경 분리**
- **개발 환경**: 로컬 개발용
- **스테이징 환경**: 프로덕션과 동일한 설정의 테스트 환경
- **프로덕션 환경**: 실제 서비스 환경

### **컨테이너화**
- **Docker**: 애플리케이션 컨테이너화
- **Docker Compose**: 개발 환경 통합 관리
- **환경변수**: 환경별 설정 분리

### **CI/CD**
- **자동 테스트**: 코드 푸시 시 자동 테스트 실행
- **자동 배포**: 테스트 통과 시 자동 배포
- **롤백**: 문제 발생 시 이전 버전으로 롤백

이 요구사항 명세서는 Dear Carmate 백엔드 개발의 완전한 가이드라인을 제공하며, 모든 기능과 비즈니스 로직을 상세히 정의합니다.